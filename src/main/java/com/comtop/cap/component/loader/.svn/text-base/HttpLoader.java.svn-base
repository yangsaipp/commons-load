package com.dreamtech.lds.component.loader;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;

import org.apache.commons.lang3.StringUtils;

import com.dreamtech.lds.component.loader.exception.LoadException;

/**
 * http 上传方式
 * @author sai.yang
 *
 */
public class HttpLoader implements Loadable {
	public static final HttpLoader instance = new HttpLoader();
	private LoaderConfig config; 
	private boolean hasContextPath = false;
	
	HttpLoader() {
		super();
	}
	
	public void downLoad(OutputStream outputStream, String folderPath, String fileName) {
		openServer();
		batchDownLoad(outputStream, folderPath, fileName);
		closeServer();
	}
	public void upload(InputStream inputStream, String folderPath, String fileName) {
		openServer();
		batchUpload(inputStream, folderPath, fileName);
		closeServer();
	}

	public void delete(String folderPath, String fileName) {
		openServer();
		batchDelete(folderPath, fileName);
		closeServer();
	}
	
	public void configure(LoaderConfig config) {
		if(config != null && StringUtils.isNotBlank(config.getContextPath())) {
			String contextPath = (LoaderHelper.replacePathSeparator(config.getContextPath()));
			//要是结尾有/那么就去掉/
			if(contextPath.endsWith(LoaderHelper.separator)) {
				contextPath = contextPath.substring(0, contextPath.length() - 1);
			}
			config.setContextPath(contextPath);
			hasContextPath = true;
		}
		this.config = config;
	}

	public void closeServer() {
		
	}
	
	public void openServer() {
	}

	public void batchDelete(String folderPath, String fileName) {
		File file = LoaderHelper.getFile(getFullFolderPath(folderPath), fileName);
		if(file.exists()) {
			file.delete();
		}
	}

	public void batchDownLoad(OutputStream outputStream, String folderPath,	String fileName) {
		InputStream inputStream = null;
		try {
			folderPath = getFullFolderPath(folderPath);
			inputStream = new BufferedInputStream(new FileInputStream(LoaderHelper.getFile(folderPath, fileName)));
			LoaderHelper.load(inputStream, outputStream);
		
		} catch (FileNotFoundException e) {
//			e.printStackTrace();		//modify by ouyang 2013-07-04 不需要打印日志，另外包装了
			throw new LoadException("服务器上文件" + fileName + "不存在，文件路径为：" + folderPath);
		} catch (IOException e) {
			e.printStackTrace();
			throw new LoadException("下载出错!");
		}finally {
//			LoaderHelper.close(outputStream);	//放到外层UploadUtil去关闭
			LoaderHelper.close(inputStream);
		}
	}

	public void batchUpload(InputStream inputStream, String folderPath, String fileName) {
		//检查文件夹路径是否存在,不存在就创建
		folderPath = getFullFolderPath(folderPath);
		File folderFile = new File(folderPath);
		if(!folderFile.exists()){
			folderFile.mkdirs();
		}
		OutputStream os = null;
		try {
			// 建立一个上传文件的输出流
			os = new BufferedOutputStream(new FileOutputStream(LoaderHelper.getFile(folderPath, fileName)));
			LoaderHelper.load(inputStream, os);
			
		} catch (FileNotFoundException e) {		//文件无法创建
			e.printStackTrace();
			throw new LoadException("服务器上创建文件" + fileName + "失败，文件创建路径为：" + folderPath);
		} catch (IOException e) {				
			e.printStackTrace();
			throw new LoadException("上传出错!");
		} finally {
			//close
//			LoaderHelper.close(inputStream);		//放到外层UploadUtil去关闭
			LoaderHelper.close(os);
		}
	}

	/**
	 * 
	 * @Methodname: getFullFolderPath
	 * @Discription: 获取全部路径(config里面有contextPath那么就会加上没有就不加)
	 * @param folderPath
	 * @return
	 *
	 */
	private String getFullFolderPath(String folderPath) {
		if(hasContextPath) {
			folderPath = LoaderHelper.replacePathSeparator(folderPath);
			
			if(!folderPath.startsWith(LoaderHelper.separator)) {
				return config.getContextPath() + LoaderHelper.separator + folderPath;
			}
			
			return config.getContextPath() + folderPath;
		}else {
			return folderPath;
		}
	}

	public boolean isHasContextPath() {
		return hasContextPath;
	}

	public void setHasContextPath(boolean hasContextPath) {
		this.hasContextPath = hasContextPath;
	}

	public LoaderConfig getConfig() {
		return config;
	}
	public String[] getFileNamesFromFolder(String folderPath){
		openServer();
		String[] names = getFileNames(folderPath);
		closeServer();
		return names;
	}
	private String[] getFileNames(String folderPath){
		folderPath = getFullFolderPath(folderPath);
		File file = new File(folderPath);
		if(file.exists()&&file.isDirectory()){
			return file.list();
		}
		return null;
	}
}
